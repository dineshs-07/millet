<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin ‚Ä¢ Millet Supply Chain ‚Äì Overview</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f5f7fa; font-family: 'Segoe UI', sans-serif; }
    .navbar { background-color: #e8f5e9; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05); }
    .navbar-brand { font-weight: bold; font-size: 1.5rem; color: #2e7d32 !important; }
    .sidebar { min-height: 100vh; background: #2e7d32; color: #fff; padding: 1rem; }
    .sidebar a { color: #fff; display: block; margin-bottom: 1rem; text-decoration: none; font-weight: 500; }
    .sidebar a:hover { text-decoration: underline; }
    .card { border: 0; border-radius: 1rem; box-shadow: 0 6px 20px rgba(0, 0, 0, .05); }
    .table td, .table th { padding-top: 0.75rem; padding-bottom: 0.75rem; vertical-align: middle; line-height: 1.4; }
    .table { font-size: 0.95rem; }
    .table-hover tbody tr:hover { background-color: #f1f1f1; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <img src="https://cdn-icons-png.flaticon.com/512/7651/7651380.png" height="36" class="me-2">
        Admin Dashboard ‚Äì Millet Supply Chain
      </a>
    </div>
  </nav>

  <div class="d-flex">
    <div class="sidebar">
      <h4 class="mb-4">üìÅ Admin Menu</h4>
      <a href="admin.html">üìä Overview</a>
      <a href="add-product.html">‚ûï Add Product</a>
      <a href="add-warehouse.html">üè¢ Add Warehouse</a>
      <a href="add-distributor.html">üë§ Add Distributor</a>
      <a href="index.html">üö™ Logout</a>
    </div>

    <div class="flex-grow-1 p-4">
      <div class="card mb-4">
        <div class="card-header fw-bold">üìä Overview Dashboard</div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="fw-semibold mb-3">Warehouses</h6>
              <div id="warehouseList" class="list-group">
                <div class="text-center text-muted">Loading warehouses...</div>
              </div>
            </div>
            <div id="warehouseDetails" class="mt-4" style="display:none;">
              <h5 class="fw-bold">Warehouse Details</h5>
              <div id="warehouseInfo" class="mb-3"></div>
              <div class="row">
                <div class="col-md-6">
                  <h6>Most Sold Product</h6>
                  <div id="mostSoldProduct"></div>
                </div>
                <div class="col-md-6">
                  <h6>6-Month Sales Summary</h6>
                  <canvas id="salesChart"></canvas>
                </div>
              </div>
              <div class="row mt-4">
                <div class="col-md-6">
                  <h6>Sale History</h6>
                  <table class="table table-sm" id="saleHistoryTable">
                    <thead><tr><th>#</th><th>Product</th><th>Qty</th><th>Amount</th><th>Date</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
                <div class="col-md-6">
                  <h6>Order History</h6>
                  <table class="table table-sm" id="orderHistoryTable">
                    <thead><tr><th>#</th><th>OrderID</th><th>Status</th><th>Total</th><th>Date</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="col-md-6">
  <h6 class="fw-semibold mb-3">Distributors</h6>
  <div id="distributorList" class="list-group">
    <div class="text-center text-muted">Loading distributors...</div>
  </div>
</div>

<div id="distributorDetails" class="mt-4" style="display:none;">
  <h5 class="fw-bold">Distributor Details</h5>
  <div id="distributorInfo" class="mb-3"></div>
  
  <div class="row">
    <div class="col-md-6">
      <h6>Most Sold Product</h6>
      <div id="distributorMostSold"></div>
    </div>
    <div class="col-md-6">
      <h6>6-Month Sales Summary</h6>
      <canvas id="distributorSalesChart"></canvas>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-6">
      <h6>Sale History</h6>
      <table class="table table-sm" id="distributorSaleHistoryTable">
        <thead>
          <tr><th>#</th><th>Product</th><th>Qty</th><th>Amount</th><th>Date</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="col-md-6">
      <h6>Order History</h6>
      <table class="table table-sm" id="distributorOrderHistoryTable">
        <thead>
          <tr><th>#</th><th>OrderID</th><th>Status</th><th>Total</th><th>Date</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>
            <div class="col-md-6">
              <h6 class="fw-semibold mb-3">Recent Activities</h6>
              <div class="table-responsive">
                <table class="table table-sm table-hover">
                  <thead class="table-light">
                    <tr><th>#</th><th>Source</th><th>Description</th><th>Timestamp</th></tr>
                  </thead>
                  <tbody id="activityLogBody">
                    <tr><td colspan="4" class="text-center">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
let salesChart; // global Chart instance

// Load warehouses list
async function loadWarehouses() {
  try {
    const res = await fetch("https://millet-backend-t5d4.onrender.com/api/warehouses");
    const data = await res.json();
    const warehouses = data.warehouses || [];
    const list = document.getElementById("warehouseList");
    list.innerHTML = "";

    if (!warehouses.length) {
      list.innerHTML = `<div class="text-center text-muted">No warehouses found</div>`;
      return;
    }

    warehouses.forEach(wh => {
      const item = document.createElement("a");
      item.href = "#";
      item.className = "list-group-item list-group-item-action";
      item.textContent = `${wh.name} (${wh.location})`;
      item.onclick = () => loadWarehouseDetails(wh.id, wh.name);
      list.appendChild(item);
    });
  } catch (err) {
    console.error("‚ùå Warehouse fetch error:", err);
    document.getElementById("warehouseList").innerHTML = `<div class="text-center text-danger">Failed to load warehouses</div>`;
  }
}

// Load warehouse details
async function loadWarehouseDetails(id, name) {
  const detailsDiv = document.getElementById("warehouseDetails");
  const warehouseInfo = document.getElementById("warehouseInfo");
  const saleTable = document.querySelector("#saleHistoryTable tbody");
  const orderTable = document.querySelector("#orderHistoryTable tbody");
  const mostSoldDiv = document.getElementById("mostSoldProduct");

  detailsDiv.style.display = "block";
  warehouseInfo.innerHTML = `<p class="text-muted">Loading warehouse details...</p>`;
  saleTable.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>`;
  orderTable.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>`;
  mostSoldDiv.innerHTML = `<p class="text-muted">Loading...</p>`;

  try {
    const res = await fetch(`https://millet-backend-t5d4.onrender.com/api/admin/warehouse-overview/${id}`);
    const data = await res.json();
    if (!data.success) throw new Error(data.error || "Failed to load warehouse");

    // Warehouse info
    warehouseInfo.innerHTML = `
      <p><b>Name:</b> ${data.name}</p>
      <p><b>Location:</b> ${data.location}</p>
      <p><b>Total Stock:</b> ${data.totalStock}</p>
    `;

    // Most sold product
    mostSoldDiv.innerHTML = `<p>${data.mostSold.product} ‚Äì ${data.mostSold.qty} units sold</p>`;

    // Sale History table (orders + order_items)
    let saleRows = "";
    data.sales.forEach((s, i) => {
      saleRows += `<tr>
        <td>${i + 1}</td>
        <td>${s.product}</td>
        <td>${s.qty}</td>
        <td>${s.amount}</td>
        <td>${s.date}</td>
      </tr>`;
    });
    saleTable.innerHTML = saleRows || `<tr><td colspan="5" class="text-center">No sales found</td></tr>`;

    // Order History table (incoming_orders)
    let orderRows = "";
    data.orders.forEach((o, i) => {
      orderRows += `<tr>
        <td>${i + 1}</td>
        <td>${o.order_id}</td>
        <td>${o.status}</td>
        <td>${o.total}</td>
        <td>${o.date}</td>
      </tr>`;
    });
    orderTable.innerHTML = orderRows || `<tr><td colspan="5" class="text-center">No orders found</td></tr>`;

    // 6-Month Sales Chart
    const ctx = document.getElementById("salesChart").getContext("2d");
    if (salesChart) salesChart.destroy();
    salesChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: data.monthlySales.map(m => m.month),
        datasets: [{
          label: "Sales Amount",
          data: data.monthlySales.map(m => m.amount),
          backgroundColor: "#2e7d32"
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });

  } catch (err) {
    console.error("‚ùå Warehouse details fetch error:", err);
    warehouseInfo.innerHTML = `<p class="text-danger">Failed to load warehouse details.</p>`;
    saleTable.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error loading sales</td></tr>`;
    orderTable.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error loading orders</td></tr>`;
    mostSoldDiv.innerHTML = `<p class="text-danger">Error loading most sold product</p>`;
  }
}

let distributorChart;

async function loadDistributors() {
  try {
    const res = await fetch("https://millet-backend-t5d4.onrender.com/api/distributors");
    const data = await res.json();
    const distributors = data.distributors || [];
    const list = document.getElementById("distributorList");
    list.innerHTML = "";

    if (!distributors.length) {
      list.innerHTML = `<div class="text-center text-muted">No distributors found</div>`;
      return;
    }

    distributors.forEach(d => {
      const item = document.createElement("a");
      item.href = "#";
      item.className = "list-group-item list-group-item-action";
      item.textContent = `${d.name} (${d.warehouse})`;
      item.onclick = () => loadDistributorDetails(d.id);
      list.appendChild(item);
    });
  } catch (err) {
    console.error("‚ùå Distributor fetch error:", err);
    document.getElementById("distributorList").innerHTML = `<div class="text-center text-danger">Failed to load distributors</div>`;
  }
}

async function loadDistributorDetails(id) {
  const detailsDiv = document.getElementById("distributorDetails");
  const infoDiv = document.getElementById("distributorInfo");
  const saleTable = document.querySelector("#distributorSaleHistoryTable tbody");
  const orderTable = document.querySelector("#distributorOrderHistoryTable tbody");
  const mostSoldDiv = document.getElementById("distributorMostSold");

  detailsDiv.style.display = "block";
  infoDiv.innerHTML = `<p class="text-muted">Loading distributor details...</p>`;
  saleTable.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>`;
  orderTable.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>`;
  mostSoldDiv.innerHTML = `<p class="text-muted">Loading...</p>`;

  try {
    const res = await fetch(`https://millet-backend-t5d4.onrender.com/api/admin/distributor-overview/${id}`);
    const data = await res.json();
    if (!data.success) throw new Error(data.error || "Failed to load distributor");

    infoDiv.innerHTML = `
      <p><b>Name:</b> ${data.name}</p>
      <p><b>Email:</b> ${data.email}</p>
      <p><b>Warehouse:</b> ${data.warehouse}</p>
      <p><b>Total Stock:</b> ${data.totalStock}</p>
    `;

    mostSoldDiv.innerHTML = `<p>${data.mostSold.product} ‚Äì ${data.mostSold.qty} units sold</p>`;

    // Sale History
    saleTable.innerHTML = data.sales.length
      ? data.sales.map((s, i) => `
        <tr>
          <td>${i+1}</td>
          <td>${s.product}</td>
          <td>${s.qty}</td>
          <td>${s.amount}</td>
          <td>${s.date}</td>
        </tr>`).join("")
      : `<tr><td colspan="5" class="text-center">No sales found</td></tr>`;

    // Incoming Orders
    orderTable.innerHTML = data.incoming.length
      ? data.incoming.map((o, i) => `
        <tr>
          <td>${i+1}</td>
          <td>${o.order_id}</td>
          <td>${o.status}</td>
          <td>${o.quantity}</td>
          <td>${o.date}</td>
        </tr>`).join("")
      : `<tr><td colspan="5" class="text-center">No orders found</td></tr>`;

    // 6-Month Chart
    const ctx = document.getElementById("distributorSalesChart").getContext("2d");
    if (distributorChart) distributorChart.destroy();
    distributorChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: data.monthlySales.map(m => m.month),
        datasets: [{
          label: "Sales Amount",
          data: data.monthlySales.map(m => m.amount),
          backgroundColor: "#2e7d32"
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

  } catch (err) {
    console.error("‚ùå Distributor details fetch error:", err);
    infoDiv.innerHTML = `<p class="text-danger">Failed to load distributor details.</p>`;
    saleTable.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error loading sales</td></tr>`;
    orderTable.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error loading orders</td></tr>`;
    mostSoldDiv.innerHTML = `<p class="text-danger">Error loading most sold product</p>`;
  }
}

// Fetch Recent Activities
async function loadActivityLogs() {
  try {
    const res = await fetch("https://millet-backend-t5d4.onrender.com/api/admin/activity-logs");
    const data = await res.json();
    const logs = data.logs || [];
    const tbody = document.getElementById("activityLogBody");
    tbody.innerHTML = "";

    if (logs.length === 0) {
      tbody.innerHTML = `<tr><td colspan="4" class="text-center">No recent activities</td></tr>`;
    } else {
      let rows = "";
      logs.forEach((log, index) => {
        const formattedDate = new Date(log.timestamp).toLocaleString("en-IN", {
          day: "2-digit", month: "2-digit", year: "numeric",
          hour: "2-digit", minute: "2-digit", hour12: true,
        });
        const source = log.source || "Unknown";
        rows += `<tr>
          <td>${index + 1}</td>
          <td>${source}</td>
          <td>${log.description}</td>
          <td>${formattedDate}</td>
        </tr>`;
      });
      tbody.innerHTML = rows;
    }
  } catch (err) {
    console.error("‚ùå Activity log fetch error:", err);
    document.getElementById("activityLogBody").innerHTML = `<tr><td colspan="4" class="text-center text-danger">Failed to load activities</td></tr>`;
  }
}

// Init
loadWarehouses();
loadDistributors();
loadActivityLogs();
</script>
</body>
</html>
